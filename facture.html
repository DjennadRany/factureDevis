<!DOCTYPE html>
<html>
<head>
  <title>Générateur de document</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>
</head>
<body>
  <h2>Générateur de document</h2>
  
  <!-- Informations sur l'entreprise -->
  <h3>Informations sur l'entreprise</h3>
  <label for="nomEntreprise">Nom de l'entreprise :</label>
  <input type="text" id="nomEntreprise"><br>
  
  <label for="adresseEntreprise">Adresse de l'entreprise :</label>
  <input type="text" id="adresseEntreprise"><br>

  <!-- Logo de l'entreprise -->
  <label for="logoEntreprise">Logo de l'entreprise :</label>
  <input type="file" id="logoEntreprise"><br>

  <label for="numeroSiret">Numéro de SIRET :</label>
  <input type="text" id="numeroSiret"><br>
  
  <!-- Informations sur le client -->
  <h3>Informations sur le client</h3>
  <label for="nomClient">Nom du client :</label>
  <input type="text" id="nomClient"><br>
  
  <label for="adresseClient">Adresse du client :</label>
  <input type="text" id="adresseClient"><br>

  <label for="codePostalClient">Code postal du client :</label>
  <input type="text" id="codePostalClient"><br>

  <!-- Autres informations sur le client -->
  <label for="numeroSiretClient">Numéro de SIRET du client :</label>
  <input type="text" id="numeroSiretClient"><br>
  
  <!-- Choix du document (facture ou devis) et référence -->
  <h3>Choix du document</h3>
  <label for="facture">Facture</label>
  <input type="radio" id="facture" name="typeDocument" value="facture">
  <label for="devis">Devis</label>
  <input type="radio" id="devis" name="typeDocument" value="devis"><br>

  <label for="referenceDocument">Référence du document :</label>
  <input type="text" id="referenceDocument"><br>

  <!-- Produits -->
  <h3>Produits</h3>
  <label for="typeProduit">Type de Produit :</label>
  <input type="radio" id="siteInternet" name="typeProduit" value="Site Internet"> Site Internet
  <input type="radio" id="flyer" name="typeProduit" value="Flyer"> Flyer
  <input type="radio" id="logo" name="typeProduit" value="Logo"> Logo
  <input type="radio" id="charteGraphique" name="typeProduit" value="Charte Graphique"><br><br>
  
  <label for="prix">Prix :</label>
  <input type="text" id="prix"><br>
  
  <!-- Champ Référence ajouté -->
  <label for="referenceProduit">Référence du produit :</label>
  <input type="text" id="referenceProduit"><br>
  
  <label for="descriptif">Descriptif :</label>
  <input type="text" id="descriptif"><br>
  
  <button onclick="ajouterProduit()">Ajouter Produit</button><br><br>

  <!-- Liste des Produits -->
  <h3>Liste des Produits</h3>
  <table>
    <thead>
      <tr>
        <th>Référence</th>
        <th>Type de Produit</th>
        <th>Prix</th>
        <th>Descriptif</th>
      </tr>
    </thead>
    <tbody id="listeProduits">
    </tbody>
  </table>

  <br>

  <!-- Générer le document -->
  <button onclick="genererDocument()">Générer le document PDF</button>
  
  <script>
    var produits = [];
    var logoDataUrl = null;

    // Fonction pour gérer le changement de logo de l'entreprise
    document.getElementById('logoEntreprise').addEventListener('change', function (event) {
      var file = event.target.files[0];
      var reader = new FileReader();
      reader.onload = function (e) {
        logoDataUrl = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    function ajouterProduit() {
      var referenceProduit = document.getElementById('referenceProduit').value;
      var typeProduit = document.querySelector('input[name="typeProduit"]:checked');
      var prix = parseFloat(document.getElementById('prix').value);
      var descriptif = document.getElementById('descriptif').value;

      if (!referenceProduit || !typeProduit || isNaN(prix) || !descriptif) {
        alert("Veuillez remplir tous les champs du produit.");
        return;
      }

      produits.push({ reference: referenceProduit, type: typeProduit.value, prix: prix, descriptif: descriptif });

      // Ajouter le produit à la liste des produits affichée
      var listeProduits = document.getElementById('listeProduits');
      var newRow = listeProduits.insertRow(-1);
      var cell1 = newRow.insertCell(0);
      var cell2 = newRow.insertCell(1);
      var cell3 = newRow.insertCell(2);
      var cell4 = newRow.insertCell(3);
      cell1.innerHTML = referenceProduit;
      cell2.innerHTML = typeProduit.value;
      cell3.innerHTML = prix + " €";
      cell4.innerHTML = descriptif;

      // Réinitialiser les champs de saisie
      document.getElementById('referenceProduit').value = "";
      document.querySelector('input[name="typeProduit"]:checked').checked = false;
      document.getElementById('prix').value = "";
      document.getElementById('descriptif').value = "";
    }

    function genererDocument() {
      if (produits.length === 0) {
        alert("Ajoutez au moins un produit avant de générer le document.");
        return;
      }

      var numeroDocument = '';
      var dateDocument = new Date().toLocaleDateString();
      var typeDocument = document.querySelector('input[name="typeDocument"]:checked').value;
      var referenceDocument = document.getElementById('referenceDocument').value;

      var montantTotalHT = produits.reduce(function (total, produit) {
        return total + produit.prix;
      }, 0);

      var montantTVA = montantTotalHT * 0.2;
      var montantTotalTTC = montantTotalHT + montantTVA;

      var nomEntreprise = document.getElementById('nomEntreprise').value;
      var adresseEntreprise = document.getElementById('adresseEntreprise').value;
      var numeroSiret = document.getElementById('numeroSiret').value;
      var nomClient = document.getElementById('nomClient').value;
      var adresseClient = document.getElementById('adresseClient').value;
      var codePostalClient = document.getElementById('codePostalClient').value;
      var numeroSiretClient = document.getElementById('numeroSiretClient').value;

      var titreDocument = typeDocument.charAt(0).toUpperCase() + typeDocument.slice(1) + " - Référence: " + referenceDocument;

      var documentDefinition = {
        pageMargins: [40, 60, 40, 60],
        content: [
          {
            text: titreDocument,
            style: 'header',
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 20]
          },
          {
            image: logoDataUrl,
            style: 'logo',
            fit: [100, 100],
            background: 'black',
            margin: [0, 0, 0, 20]
          },
          {
            columns: [
              {
                width: '*',
                text: [
                  {
                    text: 'Informations sur l\'entreprise\n',
                    style: 'header'
                  },
                  {
                    text: 'Nom de l\'entreprise: ' + nomEntreprise + '\n',
                    style: 'subheader'
                  },
                  {
                    text: 'Adresse de l\'entreprise: ' + adresseEntreprise + '\n'
                  },
                  {
                    text: 'Numéro de SIRET: ' + numeroSiret + '\n'
                  }
                ]
              },
              {
                width: '*',
                text: [
                  {
                    text: 'Informations sur le client\n',
                    style: 'header'
                  },
                  {
                    text: 'Nom du client: ' + nomClient + '\n',
                    style: 'subheader'
                  },
                  {
                    text: 'Adresse du client: ' + adresseClient + '\n'
                  },
                  {
                    text: 'Code postal du client: ' + codePostalClient + '\n'
                  },
                  {
                    text: 'Numéro de SIRET du client: ' + numeroSiretClient + '\n'
                  }
                ]
              }
            ]
          },
          {
            text: '', // Espace vide pour la séparation
            margin: [0, 20]
          },
          {
            table: {
              headerRows: 1,
              widths: ['auto', '*', 'auto', '*'],
              body: [['Référence', 'Type de Produit', 'Prix', 'Descriptif']].concat(
                produits.map(function (produit) {
                  return [produit.reference, produit.type, produit.prix + " €", produit.descriptif];
                })
              ),
            },
            layout: {
              hLineColor: function (i, node) {
                return i === 1 ? '#000' : '#DDD'; // Couleur des lignes horizontales
              },
              vLineColor: '#DDD', // Couleur des lignes verticales
              hLineWidth: function (i, node) {
                return (i === 0 || i === node.table.body.length) ? 2 : 1; // Épaisseur des lignes horizontales
              },
              vLineWidth: function (i, node) {
                return (i === 0 || i === node.table.widths.length) ? 2 : 1; // Épaisseur des lignes verticales
              },
            },
            margin: [0, 20],
            heights: 300, // Hauteur de la cellule du tableau (ajustée)
          },
          {
            text: 'Montant Total HT: ' + montantTotalHT.toFixed(2) + ' €',
            alignment: 'right',
            margin: [0, 20]
          },
          {
            text: 'Montant TVA (20%): ' + montantTVA.toFixed(2) + ' €',
            alignment: 'right',
            margin: [0, 10]
          },
          {
            text: 'Montant Total TTC: ' + montantTotalTTC.toFixed(2) + ' €',
            alignment: 'right',
            margin: [0, 10]
          },
          {
            text: '', // Espace vide pour la séparation
            margin: [0, 20]
          },
          {
            columns: [
              {
                width: '*',
                text: 'Signature du client:',
                margin: [0, 0],
              },
              {
                width: '*',
                text: 'Signature de l\'entreprise:',
                margin: [0, 0],
              }
            ]
          }
        ],
        styles: {
          header: {
            fontSize: 18,
            bold: true
          },
          subheader: {
            fontSize: 14,
            bold: true
          },
          logo: {
            width: 100,
            alignment: 'center',
            margin: [0, 0, 0, 20]
          }
        }
      };

      // Créer le PDF
      var pdfDocGenerator = pdfMake.createPdf(documentDefinition);
      pdfDocGenerator.download('document.pdf');
    }
  </script>
</body>
</html>
